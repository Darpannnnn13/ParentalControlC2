<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Subscription Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .plan-card { transition: transform 0.2s; border: 2px solid #ddd; }
        .plan-card:hover { transform: translateY(-5px); border-color: #007bff; }
        .plan-card.active { border-color: #28a745; background-color: #f0fff4; }
        .pricing-table { margin-top: 2rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container-fluid">
            <a class="navbar-brand" href="/parent/dashboard">üë®‚Äçüë©‚Äçüëß Parent Control</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/parent/dashboard">üìä Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/parent/monitoring">üì± Monitoring</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/parent/subscription">üíé Subscription</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/parent/reports">üìä Reports</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown">
                            üë§ {{ current_user.email }}
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="profileDropdown">
                            <li><a class="dropdown-item" href="/parent/settings">‚öôÔ∏è Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout">üö™ Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Current Subscription -->
        <div class="card mb-5 border-primary shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üíé Current Subscription</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Plan:</strong> <span class="badge bg-info">{{ sub.plan.upper() }}</span></p>
                        <p><strong>Status:</strong> 
                            {% if sub.limit > 0 %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-warning">Inactive</span>
                            {% endif %}
                        </p>
                        <p><strong>Devices Allowed:</strong> {{ sub.limit }}</p>
                        <p><strong>Devices Used:</strong> {{ devices_count }}</p>
                    </div>
                    <div class="col-md-6">
                        {% if sub.expiry %}
                            <p><strong>Expiry Date:</strong> {{ sub.expiry }}</p>
                            <p class="text-muted"><small>Auto-renews on expiry unless cancelled</small></p>
                        {% else %}
                            <p class="text-muted">No active subscription</p>
                        {% endif %}
                        <div class="d-grid gap-2 mt-3">
                            {% if sub.limit > 0 %}
                                <button class="btn btn-outline-danger" onclick="cancelSubscription()">Cancel Subscription</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Available Plans -->
        <h4 class="mb-4">üìã Available Plans</h4>
        <div class="row">
            <!-- Free Plan -->
            <div class="col-md-4 mb-4">
                <div class="card plan-card {% if sub.plan == 'free' %}active{% endif %}">
                    <div class="card-header bg-secondary text-white text-center">
                        <h5 class="mb-0">Free Plan</h5>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-success">‚Çπ0</h2>
                        <p class="text-muted">Forever Free</p>
                        <div class="pricing-table">
                            <ul class="list-unstyled">
                                <li>‚úì 1 Device</li>
                                <li>‚úì Basic Monitoring</li>
                                <li>‚úó Advanced Features</li>
                                <li>‚úó Priority Support</li>
                            </ul>
                        </div>
                        {% if sub.plan == 'free' %}
                            <button class="btn btn-secondary btn-sm mt-3" disabled>Current Plan</button>
                        {% else %}
                            <button class="btn btn-secondary btn-sm mt-3" onclick="selectPlan('free')">Select</button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Basic Plan -->
            <div class="col-md-4 mb-4">
                <div class="card plan-card border-primary {% if sub.plan == 'basic' %}active{% endif %}">
                    <div class="card-header bg-primary text-white text-center">
                        <h5 class="mb-0">üíé Basic Plan</h5>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-primary">‚Çπ200<span class="fs-6">/month</span></h2>
                        <p class="text-muted">Best for 1 child</p>
                        <div class="pricing-table">
                            <ul class="list-unstyled">
                                <li>‚úì 1 Device</li>
                                <li>‚úì Live Monitoring</li>
                                <li>‚úì Website Blocking</li>
                                <li>‚úì App Control</li>
                                <li>‚úì Geofencing</li>
                                <li>‚úó AI Analysis</li>
                            </ul>
                        </div>
                        {% if sub.plan == 'basic' %}
                            <button class="btn btn-primary btn-sm mt-3" disabled>Current Plan</button>
                        {% else %}
                            <button class="btn btn-primary btn-sm mt-3" onclick="selectPlan('basic')">Upgrade</button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Pro Plan -->
            <div class="col-md-4 mb-4">
                <div class="card plan-card border-success {% if sub.plan == 'pro' %}active{% endif %}">
                    <div class="card-header bg-success text-white text-center">
                        <h5 class="mb-0">‚≠ê Pro Plan</h5>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-success">‚Çπ400<span class="fs-6">/month</span></h2>
                        <p class="text-muted">Best for multiple children</p>
                        <div class="pricing-table">
                            <ul class="list-unstyled">
                                <li>‚úì 2 Devices</li>
                                <li>‚úì Live Monitoring</li>
                                <li>‚úì Website Blocking</li>
                                <li>‚úì App Control</li>
                                <li>‚úì Geofencing</li>
                                <li>‚úì AI Analysis</li>
                                <li>‚úì Advanced Reports</li>
                            </ul>
                        </div>
                        {% if sub.plan == 'pro' %}
                            <button class="btn btn-success btn-sm mt-3" disabled>Current Plan</button>
                        {% else %}
                            <button class="btn btn-success btn-sm mt-3" onclick="selectPlan('pro')">Upgrade</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Billing History -->
        <div class="card mt-5">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">üìú Billing History</h5>
            </div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Plan</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Invoice</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if billing_history %}
                            {% for bill in billing_history %}
                            <tr>
                                <td>{{ bill.date }}</td>
                                <td>{{ bill.plan }}</td>
                                <td>‚Çπ{{ bill.amount }}</td>
                                <td>
                                    {% if bill.status == 'paid' %}
                                        <span class="badge bg-success">Paid</span>
                                    {% elif bill.status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% else %}
                                        <span class="badge bg-danger">Failed</span>
                                    {% endif %}
                                </td>
                                <td><a href="#" class="text-decoration-none">Download</a></td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="5" class="text-center text-muted">No billing history yet</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- FAQ -->
        <div class="card mt-5">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">‚ùì Frequently Asked Questions</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="faqAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">What's included in each plan?</button></h2>
                        <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                <strong>Free:</strong> 1 device, basic monitoring<br>
                                <strong>Basic:</strong> 1 device, live monitoring, website/app blocking<br>
                                <strong>Pro:</strong> 2 devices, all features + AI analysis
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">Can I change my plan anytime?</button></h2>
                        <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Yes! You can upgrade or downgrade anytime. Changes take effect immediately.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">What's your refund policy?</button></h2>
                        <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                30-day money back guarantee if you're not satisfied.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function selectPlan(plan) {
            if(!confirm(`Confirm upgrade to ${plan.toUpperCase()} plan?`)) return;
            
            fetch('/parent/subscribe', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ plan: plan })
            }).then(res => res.json()).then(data => {
                if(data.success) {
                    alert('Subscription updated! Redirecting...');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            });
        }

        function cancelSubscription() {
            if(!confirm('Cancel your subscription? You will lose access to premium features.')) return;
            
            fetch('/parent/cancel_subscription', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            }).then(res => res.json()).then(data => {
                if(data.success) {
                    alert('Subscription cancelled');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            });
        }
    </script>
</body>
</html>
