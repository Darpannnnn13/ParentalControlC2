<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Control Panel - {{ pc.pc_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .screen-frame { border: 5px solid #333; border-radius: 10px; background: #000; min-height: 400px; display: flex; align-items: center; justify-content: center; }
        .screen-img { max-width: 100%; max-height: 600px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/parent/dashboard">üë®‚Äçüë©‚Äçüëß Parent Control</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/parent/dashboard">üìä Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/parent/monitoring">üì± Monitoring</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/parent/subscription">üíé Subscription</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/parent/reports">üìä Reports</a>
                    </li>
                    <li class="nav-item">
                        <span class="navbar-text text-white">{{ pc.pc_name }}</span>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <!-- Left Column: Live View -->
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üì∫ Live Screen View</h5>
                        <div>
                            <div class="form-check form-switch d-inline-block me-2">
                                <input class="form-check-input" type="checkbox" id="liveToggle" onchange="toggleLiveMode()">
                                <label class="form-check-label text-white" for="liveToggle">Live Mode</label>
                            </div>
                            <button class="btn btn-sm btn-light" onclick="sendCommand('screenshot')">üì∏ Snap</button>
                        </div>
                    </div>
                    <div class="card-body text-center bg-dark p-2">
                        <div id="screenContainer">
                            {% if pc.last_screenshot %}
                                <img src="data:image/png;base64,{{ pc.last_screenshot }}" class="screen-img" id="liveScreen">
                            {% else %}
                                <p class="text-white mt-5">No screenshot available. Click Refresh.</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        Last Active: <span id="lastSeen">Loading...</span>
                    </div>
                </div>

                <!-- Webcam View -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üì∑ Webcam</h5>
                        <button class="btn btn-sm btn-light" onclick="sendCommand('webcam_snap')">üì∏ Snap</button>
                    </div>
                    <div class="card-body text-center bg-black p-2">
                        {% if pc.last_webcam %}
                            <img src="data:image/jpeg;base64,{{ pc.last_webcam }}" class="screen-img" style="max-height: 300px;">
                        {% else %}
                            <p class="text-white mt-3">No webcam image yet.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- History / Logs -->
                <div class="card shadow">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-keys">‚å®Ô∏è Keystrokes</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-procs" onclick="sendCommand('get_processes')">‚öôÔ∏è Task Manager</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-history">üåê App History</a></li>
                        </ul>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="tab-keys">
                                <p class="text-muted">Recent keystrokes captured from device:</p>
                                <div class="bg-light p-3 border rounded" style="white-space: pre-wrap;">
                                    <code>{{ pc.keystrokes[-500:] if pc.keystrokes else 'No data yet...' }}</code>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="tab-procs">
                                <div class="d-flex justify-content-between mb-2">
                                    <small>Running Processes</small>
                                    <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">üîÑ Refresh List</button>
                                </div>
                                <table class="table table-sm table-striped">
                                    <thead><tr><th>Name</th><th>PID</th><th>Memory</th><th>Action</th></tr></thead>
                                    <tbody>
                                        {% if pc.last_processes %}
                                            {% for proc in pc.last_processes %}
                                            <tr>
                                                <td>{{ proc.name }}</td>
                                                <td>{{ proc.pid }}</td>
                                                <td>{{ proc.mem }}</td>
                                                <td><button class="btn btn-xs btn-danger" onclick="sendCommand('kill_process', '{{ proc.pid }}')">Kill</button></td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr><td colspan="4">Loading processes... Click Refresh in 5s.</td></tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="tab-pane fade" id="tab-history">
                                <p class="text-muted small">Recent active windows/tabs:</p>
                                <ul class="list-group list-group-flush small">
                                    {% if pc.window_history %}
                                        {% for item in pc.window_history | reverse %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>{{ item.title }}</span>
                                            <span class="text-muted" style="font-size:0.8em;">Just now</span>
                                        </li>
                                        {% endfor %}
                                    {% else %}
                                        <li class="list-group-item">No history yet.</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Controls -->
            <div class="col-lg-4">
                <div class="card shadow mb-4">
                    <div class="card-header bg-danger text-white">
                        <strong>üõ°Ô∏è Parental Controls</strong>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">Website Blocking</h6>
                        <div class="input-group mb-3">
                            <input type="text" id="blockUrl" class="form-control" placeholder="facebook.com">
                            <button class="btn btn-outline-danger" onclick="blockSite()">Block</button>
                            <button class="btn btn-outline-success" onclick="unblockSite()">Unblock</button>
                        </div>
                        
                        <h6 class="card-title mt-3">Remote Actions</h6>
                        <div class="input-group mb-2">
                            <input type="text" id="ttsText" class="form-control form-control-sm" placeholder="Message to speak...">
                            <button class="btn btn-sm btn-outline-info" onclick="sendTTS()">üó£Ô∏è Speak</button>
                        </div>
                        <div class="input-group mb-3">
                            <input type="text" id="openUrl" class="form-control form-control-sm" placeholder="https://google.com">
                            <button class="btn btn-sm btn-outline-success" onclick="openLink()">üåê Open</button>
                        </div>

                        <h6 class="card-title mt-4">PC Operations</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-secondary" onclick="sendCommand('lock_screen')">üîí Lock Screen</button>
                            <button class="btn btn-danger" onclick="sendCommand('shutdown')">üõë Remote Shutdown</button>
                        </div>
                    </div>
                </div>

                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <strong>‚ÑπÔ∏è System Info</strong>
                    </div>
                    <div class="card-body small">
                        <p><strong>OS:</strong> {{ pc.os_version }}</p>
                        <p><strong>User:</strong> {{ pc.username }}</p>
                        <p><strong>Uptime:</strong> Active</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const pcId = "{{ pc.pc_id }}";
        
        // Timestamps
        const sessionStart = new Date({{ pc.session_start | default(pc.last_seen, true) }} * 1000).toLocaleString();
        const lastSeen = new Date({{ pc.last_seen }} * 1000).toLocaleString();
        
        document.getElementById('startTime').innerText = sessionStart;
        document.getElementById('lastSeen').innerText = lastSeen;
        
        let liveInterval;

        function sendCommand(cmd, payload=null) {
            fetch('/api/send_command', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pc_id: pcId, command: cmd, payload: payload })
            }).then(res => res.json()).then(data => {
                if(cmd !== 'screenshot') alert('Command Sent: ' + cmd);
                if(cmd === 'screenshot' && !document.getElementById('liveToggle').checked) {
                    setTimeout(() => location.reload(), 4000);
                }
                if(cmd === 'webcam_snap') setTimeout(() => location.reload(), 4000);
            });
        }

        function toggleLiveMode() {
            const isLive = document.getElementById('liveToggle').checked;
            if (isLive) {
                sendCommand('screenshot'); // Immediate trigger
                liveInterval = setInterval(() => {
                    sendCommand('screenshot');
                    // Reload image source after delay to allow upload
                    setTimeout(() => {
                        fetch(`/api/get_pc_data/${pcId}`)
                            .then(res => res.json())
                            .then(data => {
                                if(data.screenshot) {
                                    document.getElementById('liveScreen').src = "data:image/png;base64," + data.screenshot;
                                }
                                document.getElementById('lastSeen').innerText = new Date(data.last_seen * 1000).toLocaleString();
                            });
                    }, 3000);
                }, 5000);
            } else {
                clearInterval(liveInterval);
            }
        }

        function blockSite() {
            const url = document.getElementById('blockUrl').value;
            if(url) sendCommand('block_site', url);
        }

        function unblockSite() {
            const url = document.getElementById('blockUrl').value;
            if(url) sendCommand('unblock_site', url);
        }

        function sendTTS() {
            const text = document.getElementById('ttsText').value;
            if(text) sendCommand('speak', text);
        }

        function openLink() {
            const url = document.getElementById('openUrl').value;
            if(url) sendCommand('open_url', url);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>